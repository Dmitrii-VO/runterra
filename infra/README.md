# Infrastructure

Инфраструктура проекта Runterra.

## Сервер backend (Cloud.ru)

- **SSH алиас:** `runterra` (настроен в `~/.ssh/config`)
- **IP:** `85.208.85.13`
- **Порт backend:** `3000`
- **Путь к репо:** `/home/user1/runterra`
- **Путь к backend:** `/home/user1/runterra/backend`

### Systemd сервис

```
runterra-backend.service
```

Управление:
```bash
ssh runterra "systemctl status runterra-backend"
ssh runterra "systemctl restart runterra-backend"
ssh runterra "journalctl -u runterra-backend -f"  # логи
```

### Обновление backend

На сервере есть скрипт `~/runterra/backend/update.sh`:
```bash
git pull → npm ci → npm run build → npm run migrate:prod → systemctl restart
```

**Локально** (из корня репо):
```bash
npm run deploy:backend   # push + SSH + update.sh
npm run deploy           # backend + mobile
```

## База данных (PostgreSQL)

- **Host:** localhost
- **Port:** 5432
- **Database:** runterra
- **User:** runterra

### Таблицы

| Таблица | Назначение |
|---------|------------|
| `users` | Пользователи (связь с Firebase Auth) |
| `events` | События (тренировки, забеги) |
| `event_participants` | Участники событий (join/check-in) |
| `runs` | Пробежки пользователей |
| `run_gps_points` | GPS точки пробежек |
| `migrations` | Трекинг применённых миграций |

### Миграции

Миграции хранятся в `backend/src/db/migrations/*.sql`

```bash
# Локально (dev)
cd backend && npm run migrate

# На сервере (prod) — запускается автоматически при деплое
npm run migrate:prod
```

### Подключение к БД

```bash
ssh runterra "PGPASSWORD=... psql -h localhost -U runterra -d runterra"
```

## Firebase App Distribution (mobile)

Тестировщики получают email с новой сборкой.

```bash
npm run deploy:mobile    # tests + build APK + upload + notify
```

Конфиг: `scripts/app-distribution.config.json`

## CI/CD

GitHub Actions CI (`ci.yml`) запускается на каждый push/PR в main:
- **Backend:** typecheck, tests, build
- **Mobile:** analyze, tests, build APK

Скрипт `npm run deploy` автоматически ждёт прохождения CI перед деплоем.

## TODO

### Инфраструктура
- [ ] Docker для backend
- [x] CI/CD (GitHub Actions) — проверка перед деплоем
- [x] Миграции БД
- [ ] Автодеплой после merge в main
- [ ] Staging окружение
- [ ] HTTPS / домен

### Backend (критично для MVP)
- [ ] Firebase Auth — сейчас mock, нужна реальная проверка токенов
- [x] События — запись на событие (join) с проверкой лимита
- [x] События — check-in с GPS проверкой (500м радиус)
- [x] Пробежки — валидация (≥100м, ≤30км/ч, ≥30с)
- [x] Пробежки — сохранение GPS точек

### Backend (важно)
- [x] Фильтры событий — dateFilter, clubId, difficultyLevel, eventType
- [x] Фильтры карты — события из БД (территории mock — нет таблицы)
- [x] Профиль — реальные данные из БД + статистика пробежек
- [x] Удаление аккаунта — DELETE /api/users/me

### Mobile
- [x] Backend URL — конфиг через `--dart-define=API_BASE_URL=...` (api_config.dart)
- [x] i18n — локализация строк (крупная фича)
- [x] Чат — real-time сообщения (крупная фича)
- [x] Background GPS — трекинг пробежки в фоне (крупная фича)

### Продукт (фичи)

**Тренировки и профиль**
- [x] Завершение тренировки — экран результата как в фитнес-приложении (темп, скорость, калории, placeholder пульс)
- [x] Редактирование профиля — экран/форма изменения данных пользователя (проверить)
- [x] Выбор города — настройка города пользователя
- [x] События для примера — добавить примеры событий (данные/демо)

**Чаты**
- [x] Удалить чат города — оставить только чат клуба; вместо города сделать вкладки: **Личные** / **Клуб** / **Тренер**

**Карта и трекинг**
- [x] Трекинг пробежки на карте — отображение маршрута в реальном времени во время бега (локация, интеграция с часами, опционально — показатели в реальном времени)
- [x] Кнопка «Найти клуб» — переход на карту с отображением клубов
- [x] Кнопка «Создать клуб» — сделать функциональной (создание клуба)
- [x] Убрать с карты фильтры «сегодня / неделя / мой клуб» и аналогичные

**Клубы (экран деталей клуба, по docs/product_spec.md §5.3)**
- [x] Расширить экран клуба (ClubDetailsScreen): город клуба; метрики MVP (количество участников, удерживаемые территории, рейтинг в городе — при необходимости заглушки); переход в чат клуба (кнопка «Чат клуба» → Сообщения / вкладка «Клуб» или экран чата клуба). Опционально позже: зоны активности, расписание, основатель/лидер.

**Слои карты (по аналогии с Яндекс: пробки/транспорт — включаемые слои)**
- [ ] **A) Базовый слой:** на главном экране карты всегда — захваченные территории и владельцы
- [ ] **B) Слой «Клубы»** — настройка отображения: один из слоёв — клубы
- [ ] **C) Слой «Стадионы/манежи»** — описание, дистанции, рекорды («попробуй обогнать болта»), ачивки, закрытый/открытый, цена и т.д.
- [ ] **D) Слой «Популярные маршруты»** — маршруты с рекордами
- [ ] **E) Слой «Пробежки»** — пробежки сегодня/завтра/на дату; заявка на присоединение или создание пробежки (функция присоединения/создания должна быть доступна и без этого слоя)

### Ошибки (требуют исправления)

#### Общие
- [ ] Вылет при «Начать пробежку» в Nox — краш на эмуляторе при старте foreground service (GPS). Нужно определить стратегию поддержки/ограничений для Nox и добавить guard-ы/обработку ошибок вокруг старта сервиса.
- [ ] Firebase App Distribution 403 — тестер не может скачать APK; проверить роли/группы тестировщиков и настройки дистрибуции в Firebase Console.
- [x] Profile: "type 'Null' is not a subtype of type 'bool'" — исправлено (isMercenary null-safe)
- [x] Run submit: validation error — исправлено (activityId не отправляется если null, datetime в UTC)
- [x] Карта не загружается — logcat: "You need to set the API key before using MapKit!" — исправлено (setApiKey в MainActivity до super.onCreate)
- [x] launch_background — Resources$NotFoundException на эмуляторе (bitmap @mipmap/ic_launcher) — исправлено (только цвет)

#### Клубы (выявлено 2026-02-08)
- [x] **[КРИТИЧНО]** Отсутствует Foreign Key между `clubs` и `club_members` — исправлено 2026-02-08: создана миграция `012_clubs_fk.sql`, конвертирует `club_members.club_id` из VARCHAR в UUID, удаляет orphaned records, добавляет FK с CASCADE; убран костыль `id::text` из репозитория.
- [x] **[КРИТИЧНО]** Противоречие slug-based ID vs UUID — исправлено 2026-02-08: валидация `isValidClubId()` изменена на строгий UUID-формат; обновлены комментарии; тесты используют валидные UUID вместо slug-based ID.
- [x] Нет валидации существования клуба при join/leave — исправлено 2026-02-08: добавлена проверка `clubsRepo.findById()` в `POST /api/clubs/:id/join` и `POST /api/clubs/:id/leave`, возвращается 404 если клуб не найден; обновлены тесты с моками.
- [x] Ошибка 22P02 при невалидном clubId — исправлено 2026-02-08 коммитом 097ce82: добавлена валидация `isValidClubId()` во все роуты клубов, теперь возвращается 400 с кодом `club_id_invalid` вместо 500.

### Открытые фичи (по docs/progress.md)

- [x] Участие в активностях (events/clubs) — реализовано 2026-02-04:
  - **События (join/check-in):** Backend: `userId` из auth (Firebase UID → users.id), ошибки в формате ADR-0002. Mobile: `EventsService.joinEvent`/`checkInEvent`, кнопка «Присоединиться» на EventDetailsScreen, SnackBar успеха/ошибки, i18n. Подробности — [docs/changes/events.md](../docs/changes/events.md).
  - **Клубы (присоединение к клубу):** Backend: миграция `006_club_members`, `POST /api/clubs/:id/join`, `GET /api/clubs/:id` с isMember/membershipStatus. Mobile: `ClubsService.joinClub`, кнопка «Присоединиться» и состояние «Вы в клубе» на ClubDetailsScreen. Подробности — [docs/changes/clubs.md](../docs/changes/clubs.md).
  - **Фильтр «Мой клуб»:** Backend: в профиле добавлено `user.primaryClubId` (из club_members). Mobile: CurrentClubService, чип «Мой клуб» на EventsScreen (подставляет clubId и перезапрашивает список); на карте фильтр по clubId отложен до системы слоёв. Подробности — [docs/changes/users.md](../docs/changes/users.md), [docs/changes/maps.md](../docs/changes/maps.md).

### Аудит (2026-02-04)
- [x] Исправить bulk-insert GPS точек (плейсхолдеры) и добавить тест на 2+ точки
- [x] Привести clubId к единому формату (UUID или строка) во всех слоях: DB, API, WS, mobile
- [x] Внедрить Firebase Admin SDK и убрать заглушки авторизации
- [x] Обеспечить авто-создание пользователя по валидному токену (или явный onboarding)
- [x] Добавить проверку членства для клубных чатов (HTTP + WS)
- [x] Унифицировать формат ошибок API (code/message/details) во всех эндпоинтах
- [x] Доделать флоу событий в mobile (создание, join, check-in, фильтры)
- [x] Зафиксировать production baseUrl для mobile (без localhost по умолчанию)
- [x] Убрать моки и подключить реальные данные для территорий/клубов/активностей
- [x] Реализовать mobile chat API (messages_service) для клубных/личных чатов
- [x] Добавить транзакционную защиту от оверсабскрайба на события (participant_limit)
- [x] Исправить 500 на /api/messages при отсутствии auth (возвращать 401/403)

Примечание (2026-02-06): для `participant_limit` реализован транзакционный `joinEvent` с `SELECT ... FOR UPDATE` в `backend/src/db/repositories/events.repository.ts`.

#### Feedback (2026-02-04)

##### Backend
- [x] Общий профиль: в non-prod `FirebaseAuthProvider` возвращает фиксированный uid `mock-uid-123`, поэтому все пользователи мапятся в одну запись `users`
  - Где: `backend/src/modules/auth/firebase.provider.ts`, `backend/src/auth/authMiddleware.ts`
  - Решение: в non-prod uid теперь берётся из JWT-пэйлоада или хэша токена, чтобы разные токены давали разных пользователей
- [x] Участники события: нет endpoint для списка участников с именами
  - Где: отсутствует `GET /api/events/:id/participants`
  - Решение: добавлен endpoint с join на `users` и отдачей имён/аватаров
- [x] Профиль: `club` в `/api/users/me/profile` всегда `undefined`, несмотря на `primaryClubId`
  - Где: `backend/src/api/users.routes.ts`
  - Решение: `club` теперь заполняется по `primaryClubId` (fallback name `Club <id>`)
- [x] Клубные чаты: нет endpoint для списка клубных чатов пользователя
  - Где: отсутствует `GET /api/messages/clubs` или `GET /api/clubs/my`
  - Решение: добавлен `GET /api/messages/clubs` с фильтром по членству

##### Mobile
- [x] Участники события: `ParticipantsList` генерирует `Participant N` (mock), имена не подтягиваются
  - Где: `mobile/lib/features/events/widgets/participants_list.dart`
  - Решение: подключен API `/api/events/:id/participants` и отображение реальных имён
- [x] Профиль: UI определяет наличие клуба только по `profile.club`, игнорируя `primaryClubId`
  - Где: `mobile/lib/features/profile/profile_screen.dart`, `mobile/lib/shared/models/profile_model.dart`
  - Решение: добавлен fallback по `primaryClubId` (показ клуба и корректный `hasClub`)
- [x] Сообщения/клубы: `MessagesService.getClubChats()` возвращает пустой список (stub)
  - Где: `mobile/lib/shared/api/messages_service.dart`, `mobile/lib/features/messages/tabs/club_messages_tab.dart`
  - Решение: подключен `GET /api/messages/clubs` и парсинг списка чатов

#### Feedback (2026-02-05)

##### Mobile
- [x] События: после «Присоединиться» кнопка должна стать некликабельной «Вы участвуете», и должна появиться кнопка «Отменить участие»
  - Где: `mobile/lib/features/events/event_details_screen.dart`, `mobile/lib/shared/api/events_service.dart`
  - Решение: добавлен `POST /api/events/:id/leave`, `EventDetails` теперь содержит `isParticipant/participantStatus`; в UI показываются «Вы участвуете» + «Отменить участие», добавлены тексты и обработка ошибок
- [x] События: создание события не реализовано
  - Где: `mobile/lib/shared/api/events_service.dart` (createEvent), UI экран/форма отсутствует
  - Решение: реализован `CreateEventScreen` + навигация с FAB, `createEvent()` подключен к backend
- [x] Профиль: расширить редактирование профиля (Имя, Фамилия, Дата рождения, Страна, Город, Пол)
  - Где: `backend/src/api/users.routes.ts`, `backend/src/modules/users/user.dto.ts`, `mobile/lib/features/profile/edit_profile_screen.dart`, `mobile/lib/shared/models/profile_model.dart`
  - Решение: добавлены поля пользователя + миграция, расширены profile DTO/patch, обновлены формы и отображение в профиле

#### Feedback (2026-02-05, доп.)

##### Mobile
- [x] Профиль: пол должен быть только «мужской» или «женский»
  - Где: `mobile/lib/features/profile/edit_profile_screen.dart`, `mobile/l10n/*.arb`, `backend/src/modules/users/user.dto.ts`
  - Решение: enum и валидация ограничены `male|female`, UI показывает только эти варианты, миграция очищает некорректные значения
- [x] Профиль: дата рождения сохраняется на день раньше (пример: 03.02.1994 → 02.02.1994)
  - Где: `mobile/lib/shared/api/users_service.dart` (формат `YYYY-MM-DD`), `backend/src/db/repositories/users.repository.ts` (parse Date), `backend/src/api/users.routes.ts` (toISOString().slice(0,10))
  - Решение: backend возвращает дату как `YYYY-MM-DD` без UTC сдвига, на стороне repo нормализация даты без `toISOString`
- [x] События: после нажатия «Присоединиться» сначала показывается «Запись на событие - TODO»
  - Где: `mobile/lib/features/events/event_details_screen.dart`, `mobile/l10n/*.arb`
  - Решение: добавлен `eventJoinInProgress` и обновлены тексты без TODO
- [x] Клубы: нет кнопки «Выйти из клуба»
  - Где: `mobile/lib/features/club/club_details_screen.dart`, `mobile/lib/shared/api/clubs_service.dart`, backend clubs API
  - Решение: добавлен `POST /api/clubs/:id/leave`, `ClubsService.leaveClub()`, UI кнопка «Выйти из клуба» и очистка currentClubId

#### Feedback (2026-02-06)

##### Mobile
- [x] Во вкладке «Сообщения → Клуб» нет чата и нет поля ввода сообщения; надпись с названием клуба в этом месте не нужна.
- [x] Во вкладке «Пробежка» при старте не отображается позиция и нет кнопки «Найти себя» (как в навигаторах); после пробежки темп считается некорректно/непрозрачно.
  - Решение (2026-02-08): Добавлен CircleMapObject для отображения текущей позиции при 1+ GPS-точках; добавлена FAB кнопка «Найти себя» для центрирования карты; увеличен порог отображения темпа с 10м до 50м для стабилизации GPS; добавлено отображение текущего темпа во время пробежки.
- [x] После создания клуба «Пупкины» отображается наименование Club new-club-id, описание не соответствует введенному при создании, и создатель не является участником клуба.
  - Решение (2026-02-08): Создана миграция 010_clubs.sql с таблицей clubs; реализован ClubsRepository; обновлены POST /api/clubs и GET /api/clubs/:id для работы с БД; при создании клуба создатель автоматически добавляется в club_members со статусом active.
- [x] События, которые уже прошли, отображаются со статусом «Открыто».
  - Решение (2026-02-08): Добавлена миграция 011_events_end_date_time.sql с полем end_date_time; обновлены Event entity, DTO и EventsRepository; реализована функция computeEventStatus для time-based перехода в COMPLETED если endDateTime прошло.

#### Feedback (2026-02-08)

##### Клубы
- [x] Создатель клуба — Администратор (исправлено 2026-02-08): добавлено поле role в club_members (миграция 013), создатель получает роль leader; добавлен метод countActiveMembers(); GET /api/clubs/:id возвращает реальное количество участников.

##### События
- [x] Вкладка «События»: фильтр «Только открытые» показывал прошедшие события (исправлено 2026-02-08): добавлено условие (end_date_time IS NULL OR end_date_time > NOW()) в фильтр EventsRepository.findAll().

### Клубы MVP — чего не хватает для уверенного релиза

По спеке (product_spec §5.3, 16.5) и текущему состоянию кода. Роли в клубе уже приведены к **Лидер / Тренер / Участник** (миграция 014, ClubRole.TRAINER, профиль возвращает реальную роль).

#### Точка входа и список клубов
- [ ] **Отдельная точка входа «Клубы»** — в спеке: «Пользователь открывает раздел "Клубы"». Сейчас клубы доступны только через карту («Найти клуб» → bottom sheet) или после «Создать клуб». Нужно: либо вкладка «Клубы» в нижней навигации, либо явный блок «Клубы» в профиле с переходом на экран списка.
- [ ] **Экран списка клубов** — отдельный экран со списком клубов по выбранному городу (GET /api/clubs?cityId=…), тап по клубу → детали клуба. Сейчас список только в bottom sheet на карте при showClubs=true.

#### Профиль клуба (экран деталей)
- [ ] **Основатель/лидер в API и UI** — в спеке: «Профиль клуба: … основатель/лидер клуба». В БД есть clubs.creator_id, но GET /api/clubs/:id не отдаёт creatorId/creatorName. На ClubDetailsScreen нет блока «Основатель» / «Лидер». Нужно: в ответ добавить creatorId (и при необходимости имя создателя); на экране клуба показывать «Основатель: …».
- [ ] **Роль текущего пользователя (myRole)** — GET /api/clubs/:id не возвращает роль участника (member/trainer/leader). Без этого нельзя показать «Вы — лидер» / «Вы — тренер» / «Вы — участник» и разграничить действия по ролям. Нужно: в ответ при isMember добавить myRole; на экране клуба показывать роль пользователя.
- [ ] **Блок «События клуба»** — в спеке: «Выбирает клуб → видит профиль с расписанием». На экране клуба нет блока с предстоящими событиями этого клуба. Backend: GET /api/events?clubId=… уже есть. Нужно: на ClubDetailsScreen секция «Ближайшие события» — запрос событий по clubId и список карточек.

#### Управление клубом (для лидера)
- [ ] **Редактирование профиля клуба** — в спеке лидер может редактировать профиль (название, описание). Сейчас нет PATCH /api/clubs/:id и экрана/формы редактирования. Нужно: PATCH с проверкой, что запрос от лидера; форма редактирования (или экран) для лидера на ClubDetailsScreen.

#### Уже сделано (для контекста)
- Роли: Лидер, Тренер, Участник (enum, БД, профиль возвращает реальную роль).
- Создатель клуба автоматически добавляется в club_members с ролью leader; membersCount считается по активным участникам.
- Join/leave, детали клуба (название, город, метрики, чат, описание), создание клуба, переход в чат клуба.

#### Детализация запроса пользователя (2026-02-08, клубы в профиле и сообщениях)

Контекст запроса:
- Пользователь сообщил: его профиль состоит в нескольких клубах, но это не отображается в UI.
- Требование 1: во вкладке «Профиль» нужна отдельная кнопка «Клубы» с показом всех клубов, где состоит пользователь.
- Требование 2: во вкладке «Сообщения → Клуб» сначала должен быть выбор клуба, и только после клика должен открываться чат выбранного клуба.

##### 1) Профиль: список всех клубов пользователя
- [x] **Отдельная точка входа «Клубы» в профиле** (реализовано 2026-02-08):
  - Где сейчас: в `ProfileScreen` нет отдельного экрана/кнопки «Мои клубы», отображается только агрегированный `club` + `primaryClubId`.
  - Нужно: добавить явную кнопку/плитку «Клубы» в профиле, ведущую на экран списка клубов пользователя.
- [x] **API для списка всех членств пользователя** (реализовано 2026-02-08):
  - Где сейчас: профиль (`GET /api/users/me/profile`) возвращает только один клуб (primary), этого недостаточно.
  - Нужно: вернуть все активные членства пользователя с базовой информацией по клубу (id, name, cityId/cityName, role, joinedAt).
  - Вариант MVP: добавить `GET /api/clubs/my` (предпочтительно для доменной логики клубов), не перегружать профиль лишними полями.
  - Контракт `GET /api/clubs/my`:
    - Auth: Bearer token (обязателен)
    - 200: `[{ id, name, description?, cityId, cityName?, status, role, joinedAt }]`
    - role: `member | trainer | leader`
    - Сортировка: по `joinedAt` по убыванию (сначала последний вступивший клуб)
    - 401: `{ code: "unauthorized", message: "Authorization required" | "User not found" }`
    - 500: `{ code: "internal_error", message: "Internal server error" }`
- [x] **Экран «Мои клубы» (mobile)** (реализовано 2026-02-08):
  - Список карточек клубов: название, город, роль пользователя (leader/trainer/member).
  - Клик по карточке: переход на `ClubDetailsScreen`.
  - Empty state: пользователь не состоит ни в одном клубе.
  - Error/retry state: по стандартному паттерну экранов mobile.

##### 2) Сообщения: выбор клуба перед открытием чата
- [ ] **Разделить «выбор клуба» и «чат клуба»**:
  - Где сейчас: `ClubMessagesTab` автоматически выбирает клуб (`primaryClubId`/последний активный) и сразу открывает чат.
  - Нужно: первым экраном таба показывать список клубов пользователя; чат открывать только после явного выбора клуба.
- [ ] **Список клубов в табе «Клуб»**:
  - Источник данных: список членств/клубов пользователя.
  - Для каждого клуба показать минимум: название клуба + превью последней активности (если доступно).
  - Если клубов нет: понятный empty state без поля ввода сообщения.
- [ ] **Экран/состояние чата выбранного клуба**:
  - После выбора клуба открывается текущий чат этого клуба (история + отправка сообщений).
  - Нужен явный возврат к списку клубов (например, back в пределах таба).
  - Переход из `ClubDetailsScreen` в сообщения должен предвыбирать нужный клуб (через `clubId` в роуте/состоянии).

##### 3) Технические ограничения и согласованность MVP
- [ ] Не ломать текущий контракт авторизации и проверки членства в backend chat API.
- [ ] Для mobile не делать API-вызовы напрямую в `FutureBuilder.future`; кэшировать `Future` в `initState`.
- [ ] Все новые пользовательские строки добавить в `mobile/l10n/app_ru.arb` и `mobile/l10n/app_en.arb`.
- [ ] Приоритет MVP: сначала корректный выбор клуба и отображение членств, затем UX-улучшения (поиск, сортировка, бейджи непрочитанных).

##### 4) Критерии приёмки (DoD)
- [x] В профиле есть кнопка «Клубы», открывающая список всех клубов пользователя.
- [x] Пользователь, состоящий в нескольких клубах, видит все свои клубы в одном экране.
- [x] Во вкладке «Сообщения → Клуб» первым шагом отображается список клубов, а не чат.
- [x] Чат клуба открывается только после выбора клуба пользователем.
- [x] Переход из карточки клуба в сообщения открывает чат именно этого клуба.

##### 5) План параллельной реализации (независимые подзадачи)

1. **API-контракт (фиксируется один раз)**
   - Выход: короткая спека `GET /api/clubs/my` (поля, сортировка, ошибки, примеры).
   - Зависимости: нет.
   - Параллельность: выполняется отдельно, задаёт единый формат для команд.

2. **Backend: endpoint списка клубов пользователя**
   - Выход: `GET /api/clubs/my`, репозиторный метод, unit/integration тесты.
   - Зависимости: п.1.
   - Параллельность: не зависит от mobile UI.

3. **Mobile data layer: модель + сервис «мои клубы»**
   - Выход: модель `MyClubModel` и метод `ClubsService.getMyClubs()`.
   - Зависимости: п.1 (можно стартовать с мок-контракта).
   - Параллельность: не зависит от конкретных экранов.

4. **Mobile Profile: CTA «Клубы»**
   - Выход: отдельная кнопка/плитка «Клубы» в `ProfileScreen` с навигацией.
   - Зависимости: нет (экран можно подключить позже).
   - Параллельность: полностью независима от backend.

5. **Mobile Profile: экран «Мои клубы»**
   - Выход: список клубов пользователя, empty/error/retry, переход в `ClubDetailsScreen`.
   - Зависимости: п.3 (или временный мок-источник).
   - Параллельность: независим от вкладки сообщений.

6. **Mobile Messages: экран выбора клуба** ✅
   - Выход: в табе «Клуб» первым шагом отображается список клубов, без авто-открытия чата.
   - Зависимости: п.3.
   - Параллельность: можно делать отдельно от чата выбранного клуба.

7. **Mobile Messages: чат выбранного клуба** ✅
   - Выход: состояние «клуб выбран», история + отправка сообщений, возврат к выбору клуба.
   - Зависимости: п.6.
   - Параллельность: независим от профиля.

8. **Навигация и deep-link клуба в сообщения** ✅
   - Выход: поддержка `clubId` в маршруте (`/messages?tab=club&clubId=...`) и переход из `ClubDetailsScreen`.
   - Зависимости: нет, интеграция с п.6/п.7 на финале.
   - Параллельность: может идти отдельным потоком.

9. **i18n + документация + приёмка** ✅
   - Выход: новые ключи в `mobile/l10n/app_ru.arb` и `mobile/l10n/app_en.arb`, обновления `docs/progress.md`, `docs/changes/*`, финальный прогон DoD.
   - Зависимости: после слияния п.2–п.8.
   - Параллельность: финальный этап, выполняется последним.
