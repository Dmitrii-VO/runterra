# Сборка и отправка приложения для тестирования

Инструкция по сборке APK файла и отправке приложения друзьям/тестировщикам.

## Одна команда: деплой всего (backend + mobile)

Из корня репозитория:

```bash
npm run deploy
```

Это запускает **`deploy-all.ps1`**, который по порядку:

### Backend (на сервере runterra)
1. Проверка что нет незакоммиченных изменений
2. `git push` в origin (если есть новые коммиты)
3. SSH → `~/runterra/backend/update.sh` на сервере:
   - `git pull`
   - `npm ci`
   - `npm run build`
   - `systemctl restart runterra-backend`

### Mobile (Firebase App Distribution)
1. **Тесты** — `flutter test`
2. **Сборка** — `flutter build apk --debug`
3. **Деплой** — загрузка APK в Firebase App Distribution
4. **Уведомление** — тестировщикам уходит email

---

## Отдельные команды

**Только backend:**
```bash
npm run deploy:backend
```

**Только mobile:**
```bash
npm run deploy:mobile
```

**С release-notes:**
```bash
.\scripts\deploy-mobile.ps1 "Исправлен вход через Google"
.\scripts\deploy-all.ps1 "Новая фича"
```

**Без тестов (быстрее):**
```bash
.\scripts\deploy-mobile.ps1 -SkipTests
.\scripts\deploy-all.ps1 -SkipTests
.\scripts\deploy-all.ps1 "Быстрый билд" -SkipTests
```

---

## Конфигурация

**Список тестировщиков** — `scripts/app-distribution.config.json`:
```json
{
  "firebaseAppId": "1:718457871498:android:adbf0a55f96734f85b6173",
  "testers": ["luckyleeop@gmail.com", "другой@email.com"]
}
```

**SSH хост** — в скриптах используется алиас `runterra` (настроен в `~/.ssh/config`).

**Перед первым запуском:**
- `firebase login` (для mobile)
- SSH ключ должен быть настроен для хоста `runterra`

---

## Сборка APK файла

### Вариант 1: Debug APK (быстро, для тестирования)

```bash
cd mobile
flutter build apk --debug
```

**Результат:** Файл будет в `mobile/build/app/outputs/flutter-apk/app-debug.apk`

**Особенности:**
- Быстрая сборка
- Больший размер файла (включает отладочную информацию)
- Подходит для тестирования функциональности
- Не требует настройки подписи

### Вариант 2: Release APK (оптимизированный)

```bash
cd mobile
flutter build apk --release
```

**Результат:** Файл будет в `mobile/build/app/outputs/flutter-apk/app-release.apk`

**Особенности:**
- Меньший размер файла
- Оптимизированный код
- Требует настройки подписи (сейчас используется debug подпись)
- Подходит для более стабильного тестирования

## Размер файла

- **Debug APK:** ~50-100 МБ (зависит от зависимостей)
- **Release APK:** ~20-40 МБ

## Отправка APK другу

### Способ 1: Прямая отправка файла

1. Найдите собранный APK файл:
   - Debug: `mobile/build/app/outputs/flutter-apk/app-debug.apk`
   - Release: `mobile/build/app/outputs/flutter-apk/app-release.apk`

2. Отправьте файл через:
   - **Telegram** (до 2 ГБ)
   - **Email** (если файл < 25 МБ)
   - **Google Drive / Dropbox** (создайте ссылку для скачивания)
   - **Облачное хранилище** (Яндекс.Диск, OneDrive и т.д.)

### Способ 2: Через файлообменник

1. Загрузите APK на файлообменник:
   - [SendAnywhere](https://send-anywhere.com/)
   - [WeTransfer](https://wetransfer.com/)
   - [File.io](https://www.file.io/)

2. Отправьте ссылку другу

## Установка APK на Android устройство

### Инструкция для друга:

1. **Скачать APK файл** на Android устройство

2. **Разрешить установку из неизвестных источников:**
   - Открыть **Настройки** → **Безопасность** (или **Приложения**)
   - Включить **"Установка из неизвестных источников"** или **"Неизвестные источники"**
   - На Android 8+: при установке система спросит разрешение для конкретного приложения

3. **Установить APK:**
   - Открыть файловый менеджер
   - Найти скачанный APK файл
   - Нажать на файл → **Установить**
   - Подтвердить установку

4. **Запустить приложение:**
   - Найти иконку "Runterra" в списке приложений
   - Запустить

## Важные замечания

### Для тестирования приложения нужно:

1. **Mapbox токен** (если тестируете карту):
   - Убедитесь, что в `AndroidManifest.xml` указан реальный Mapbox токен
   - Без токена карта не будет работать

2. **Backend сервер** (если тестируете API):
   - Backend должен быть запущен и доступен
   - Для тестирования с другого устройства нужно:
     - Узнать IP адрес компьютера в локальной сети
     - Обновить `ApiConfig.getBaseUrl()` в коде (или использовать переменные окружения)
     - Убедиться, что устройства в одной сети

3. **Firebase** (если тестируете авторизацию):
   - Firebase уже настроен и будет работать
   - Но экраны логина ещё не реализованы (skeleton стадия)

### Ограничения skeleton стадии:

- Большинство функций возвращают заглушки (mock-данные)
- Нет реальной авторизации (только архитектура)
- Нет сохранения данных (всё в памяти)
- Карта работает только если есть Mapbox токен

## Альтернативные способы тестирования

### 1. Через USB отладку (ADB)

Если друг рядом и есть USB кабель:

```bash
cd mobile
flutter install
```

Приложение установится напрямую на подключённое устройство.

### 2. Через Firebase App Distribution (рекомендуется)

Используйте одну команду из корня: **`npm run deploy`** (см. раздел выше).

Тестировщики получают email от Firebase, устанавливают приложение **Firebase App Tester**, после чего видят все новые сборки и могут обновляться в один тап. Добавление новых тестировщиков — в Firebase Console → App Distribution → Testers или через `scripts/app-distribution.config.json`.

## Проверка перед отправкой

Перед отправкой APK другу убедитесь:

- [ ] Приложение собирается без ошибок
- [ ] Основные экраны открываются
- [ ] Нет критических ошибок при запуске
- [ ] Mapbox токен настроен (если нужна карта)
- [ ] Backend доступен (если тестируете API)

## Размер файла и оптимизация

Если APK файл слишком большой:

1. **Использовать release сборку:**
   ```bash
   flutter build apk --release
   ```

2. **Разделить по архитектурам:**
   ```bash
   flutter build apk --split-per-abi
   ```
   Создаст отдельные APK для разных архитектур (меньше размер)

3. **Проверить зависимости:**
   - Убедитесь, что не подключены лишние пакеты
   - Используйте `flutter pub deps` для анализа зависимостей

## Troubleshooting

### Друг не может установить APK

**Проблема:** "Установка заблокирована"

**Решение:**
- Убедитесь, что включена установка из неизвестных источников
- На Android 8+ нужно разрешить установку для конкретного приложения/браузера

### Приложение не запускается

**Проблема:** Крэш при запуске

**Решение:**
- Проверьте логи: `adb logcat` (если устройство подключено)
- Убедитесь, что все зависимости установлены
- Проверьте, что Firebase инициализирован корректно

### Карта не работает

**Проблема:** Пустая карта или ошибка

**Решение:**
- Проверьте, что Mapbox токен указан в `AndroidManifest.xml`
- Убедитесь, что есть интернет-соединение

### Deploy зависает на «Upload to Firebase App Distribution» / «uploading binary...»

**Проблема:** Скрипт деплоя останавливается на шаге загрузки бинарника в Firebase App Distribution, прогресс не отображается.

**Что попробовать:**

1. **Подождать 5–15 минут** — debug APK может быть 50–100 МБ; загрузка идёт, но CLI не всегда показывает прогресс.
2. **Проверить сеть** — отключить VPN, попробовать другой Wi‑Fi; корпоративный прокси/файрвол может резать или блокировать загрузку.
3. **Запуск с отладкой** (увидеть, что происходит):
   - PowerShell: `$env:FIREBASE_DEBUG="*"; .\scripts\deploy-mobile.ps1`
   - Или: `$env:DEPLOY_DEBUG="1"; .\scripts\deploy-mobile.ps1` (если скрипт поддерживает).
4. **Обновить Firebase CLI:** `npm install -g firebase-tools`
5. **Проверить авторизацию:** `firebase login` (перелогиниться при необходимости).
6. **Собрать release APK** (меньше размер) — в скрипте заменить `flutter build apk --debug` на `--release` и путь на `app-release.apk`; затем запустить деплой.
7. **Ручная загрузка:** Firebase Console → App Distribution → выбрать приложение → «Release» → загрузить APK вручную; тестеров уведомить отдельно.

## Следующие шаги

После тестирования skeleton:

1. Собрать обратную связь от тестировщиков
2. Определить приоритеты для следующих этапов разработки
3. Реализовать основные функции согласно feedback
