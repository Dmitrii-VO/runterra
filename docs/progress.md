# Прогресс разработки

## Обзор
Документ отслеживает выполнение задач и прогресс разработки проекта Runterra.

## История изменений

### 2025-01-27
- **Пользователи / профиль:** контракт `club === null`, mock-флаг для заглушек, правила меркателя, ProfileScreen как точка входа. Подробности — [changes/users.md](changes/users.md).
- **События (Events) MVP:** архитектурная основа модуля Events (backend + mobile), типы, DTO, API роутеры, UI компоненты, инварианты статусов. Подробности — [changes/events.md](changes/events.md).
- **Messages MVP табы по 123.md:** табы «Город | Клубы | Уведомления», убраны личные переписки, добавлена вкладка уведомлений, обновлён empty state городского чата. Подробности — [changes/messages.md](changes/messages.md).
- **Run Tab MVP:** реализация MVP вкладки Run согласно 123.md — GPS-трекинг, таймер, три состояния (idle/recording/result), backend модуль runs, API для сохранения пробежек. Подробности — [changes/runs.md](changes/runs.md).
- **Maps MVP:** архитектурная основа карты согласно 123.md — API endpoint для данных карты, модели, сервисы, UI компоненты (территории, события, фильтры, кнопка "Моё местоположение"). Подробности — [changes/maps.md](changes/maps.md).
- **Логирование ошибок пользователей (Sentry):** интеграция Sentry для мониторинга ошибок в mobile (Flutter) и backend (Node.js). Перехват необработанных исключений, явная отправка ошибок из ключевых мест. Подробности — [changes/logging.md](changes/logging.md), [adr/0001-sentry-error-logging.md](adr/0001-sentry-error-logging.md).
- **Настройка Firebase Authentication для Android:** интеграция Firebase Authentication в мобильное приложение — конфигурация Firebase проекта, настройка Gradle, добавление зависимостей, инициализация в коде. Подробности — [changes/firebase-setup.md](changes/firebase-setup.md), [docs/firebase-setup.md](firebase-setup.md).

### 2026-01-31
- **Mobile API base URL — облачный backend по умолчанию (debug):** в `api_config.dart` для debug-сборок при отсутствии `--dart-define=API_BASE_URL` используется облачный backend `http://85.208.85.13:3000` (Cloud.ru); для release/production поведение без изменений (https). Подробности — [changes/api-client.md](changes/api-client.md).

### 2026-01-27
- **Backend dev compile fix (Sentry types):** добавлены минимальные TypeScript-типизации для `@sentry/node` в backend, чтобы устранить ошибку TS2307 при локальном запуске без изменения рантайм-поведения. Поведение логирования Sentry осталось без изменений.
 - **Mobile debug build проверен:** выполнена сборка `flutter build apk --debug` для мобильного клиента, критических ошибок нет, APK успешно собран; предупреждения по версии Android Gradle Plugin зафиксированы как технический долг без изменений конфигурации на текущем skeleton-этапе.

### 2026-01-29
- **Backend Firebase auth stub safety:** заглушка проверки Firebase ID токенов в backend помечена как SECURITY STUB, добавлены проверки `NODE_ENV` в `verifyToken`, а также startup-check `assertFirebaseAuthConfigured()` при запуске сервера; в production окружении использование заглушки теперь приводит к немедленной ошибке, чтобы исключить случайный деплой без реальной интеграции Firebase Admin SDK.
 - **Backend API auth middleware:** добавлено глобальное middleware авторизации для всех `/api` роутов, которое ожидает заголовок `Authorization: Bearer <token>` и проксирует проверку в `AuthService.verifyToken()` (FirebaseAuthService stub); в случае отсутствия или невалидного токена эндпоинты возвращают `401 Unauthorized`. Поведение доменных заглушек не изменено, ограничение касается только доступа.
 - **Backend runtime-валидация POST DTO:** подключена техническая runtime-валидация тел запросов для POST-эндпоинтов `activities`, `cities`, `clubs`, `events`, `runs`, `territories`, `users` с использованием Zod-схем на основе существующих `Create*Dto`. Добавлено общее middleware `validateBody(schema)`; при несоответствии формы/типов входных данных backend возвращает `400 Bad Request`, бизнес-логика и доменные инварианты по-прежнему остаются заглушками.
 - **API ошибки и политика валидации:** введён единый конверт ошибок API `{ code; message; details? }`, стандартизирован формат ошибок валидации (`code: \"validation_error\"`, `details.fields[{ field; message; code }]`) для Zod, а также форма ответов `401 Unauthorized` в `authMiddleware`; локализация текстов ошибок остаётся на стороне клиентов. Подробности — [adr/0002-api-error-format-and-validation.md](adr/0002-api-error-format-and-validation.md), [docs/api-errors-and-validation.md](api-errors-and-validation.md).
 - **Mobile FutureBuilder state fix:** экраны деталей (`ActivityDetailsScreen`, `CityDetailsScreen`, `ClubDetailsScreen`, `TerritoryDetailsScreen`, `EventDetailsScreen`) и вкладки сообщений (`GlobalChatTab`, `ClubMessagesTab`, `NotificationsTab`) переведены на `StatefulWidget` с кэшированными `Future` в `initState`, чтобы избежать повторного выполнения HTTP-запросов и заглушек при каждом `rebuild`; бизнес-логика и доменные инварианты не изменены.
 - **Mobile Maps territory radius fix:** радиус placeholder-территорий на карте пересчитан из фиксированных пикселей в экранно-зависимый размер на основе zoom/широты, чтобы приблизительно соответствовать 500 м в реальных метрах и масштабироваться корректно при зуме; доменная логика территорий не изменена, правка затрагивает только визуализацию в `MapScreen`.
 - **Mobile Run duration format fix:** исправлен баг форматирования длительности пробежки в `RunScreen`, из-за которого пробежки дольше 60 минут отображались без часов (например, 1:30:00 как `30:00`); теперь при наличии часов время показывается в формате `H:MM:SS`, иначе `MM:SS`.
 - **Mobile Territories coordinates model dedup:** дублирующийся класс `TerritoryCoordinates` объединён в одну DTO-модель в `territory_model.dart`, `territory_map_model.dart` теперь использует импорт вместо собственной копии; это устраняет конфликт имен при совместном использовании обеих моделей без изменения структуры данных или доменной логики.
 - **Logging refactor (local + dev remote logs):** Sentry интеграция во всех компонентах временно отключена; на backend добавлен простой структурированный логгер и dev-only эндпоинт `POST /dev/log` для приёма удалённых логов от мобильного приложения, в Flutter-клиенте `sentry_flutter` заменён на лёгкий `DevRemoteLogger`, который отправляет технические ошибки на локальный backend. Подробности — [changes/logging.md](changes/logging.md), [adr/0003-local-logging-and-dev-remote-logs.md](adr/0003-local-logging-and-dev-remote-logs.md).
 - **Dev-логи на единый удалённый сервер:** логи в dev отправляются только на внешний лог-сервер (POST /log, http://176.108.255.4:4000); в PROD отправка отключена. Backend: модуль `devLogClient`, при error/warn — fire-and-forget POST на сервер; эндпоинт `/dev/log` удалён. Mobile: `DevRemoteLogger` отправляет только при заданном `DEV_LOG_SERVER` (в prod не задаётся); путь `/log`. Admin: добавлена утилита `sendDevLog` для будущих ошибок API. Единая точка приёма логов — удалённый сервер; чувствительные данные не логируются. Подробности — [changes/logging.md](changes/logging.md).
 - **Mobile Events RefreshIndicator fix:** в `EventsScreen` метод `_refreshEvents()` переведён на возврат `Future<void>` с ожиданием завершения `_fetchEvents()`; `RefreshIndicator.onRefresh` передаётся напрямую `_refreshEvents`, чтобы спиннер pull-to-refresh не исчезал до окончания загрузки. Подробности — [changes/events.md](changes/events.md).
- **Mobile RunService baseUrl fix:** в `RunService` fallback для `ApiClient` заменён с хардкода `http://localhost:3000` на `ApiConfig.getBaseUrl()`, чтобы submit пробежки работал на Android-эмуляторе (10.0.2.2). Подробности — [changes/runs.md](changes/runs.md).
- **firebaseUid утекает в API-ответах (безопасность):** пользовательские эндпоинты `GET /api/users`, `GET /api/users/:id`, `POST /api/users` больше не возвращают сущность User с полем firebaseUid; введён маппинг User → UserViewDto (без firebaseUid) и функция `userToViewDto`. Эндпоинт `GET /api/users/me/profile` уже не раскрывал firebaseUid (ProfileDto.user — отдельный контракт). Подробности — [changes/users.md](changes/users.md).
 - **Единый DB pool (устранение дублирования):** удалён модуль `shared/db`; оставлен единственный источник пула PostgreSQL — `db/client.ts`. Устранены два параллельных пула с коллизией `getDbPool()` и удвоением соединений при импорте обоих. Подробности — [changes/database.md](changes/database.md).
 - **Backend graceful shutdown (DB pool):** в `server.ts` добавлен технический обработчик сигналов `SIGTERM`/`SIGINT`, который при завершении процесса вызывает `closeDbPool()` из `db/client.ts` и логирует результат через `logger`; цель — корректно закрывать пул PostgreSQL и не оставлять висящие соединения при остановке backend-сервера. Подробности — [changes/database.md](changes/database.md).
 - **DB_PASSWORD в production (безопасность):** в production окружении запуск backend без заданного `DB_PASSWORD` приводит к выбросу ошибки в `getDbConfig()` (config/db.ts); дефолт пустой строки сохранён только для не-production. Подробности — [changes/database.md](changes/database.md).
- **Invalid Date при создании run (баг):** в `CreateRunSchema` поля `startedAt` и `endedAt` заменены с `z.string()` на `z.string().datetime()`, чтобы невалидные ISO-строки отклонялись до парсинга; при некорректном формате даты backend возвращает `400` с validation_error вместо сериализации Invalid Date в null. Подробности — [changes/runs.md](changes/runs.md).
- **Mobile API auth (безопасность):** в `ApiClient` добавлена поддержка опционального `authToken` и автоматическая подстановка заголовка `Authorization: Bearer <token>` во все GET и POST запросы; механизм инъекции токена готов, передача токена при создании клиента — ответственность вызывающего кода (например Firebase ID token). Подробности — [changes/api-client.md](changes/api-client.md).
- **Mobile API base URL — HTTPS по умолчанию (безопасность):** в `api_config.dart` по умолчанию используется схема https для base URL; для dev/emulator можно оставить http через `--dart-define=API_BASE_URL=http://10.0.2.2:3000` (или http://localhost:3000). В production не передавать API_BASE_URL — тогда используется https с платформенным хостом. Подробности — [changes/api-client.md](changes/api-client.md).
- **Mobile ApiClient — синглтон и dispose (утечка ресурсов):** `ApiClient` создавал новый `http.Client()` на каждый экран без вызова `close()`, сокеты не закрывались. Введён синглтон через `ApiClient.getInstance(baseUrl:, authToken?)` — один экземпляр на приложение, один `http.Client`. Добавлен метод `dispose()` для закрытия клиента и сброса синглтона (тесты, явный logout). Все экраны и сервисы переведены на `getInstance()`. Подробности — [changes/api-client.md](changes/api-client.md).
- **Mobile ServiceLocator (DI):** внедрён простой ServiceLocator: ApiClient и все API-сервисы создаются один раз в `ServiceLocator.init()` при старте приложения (в `main.dart`). Экраны и вкладки получают сервисы через `ServiceLocator.eventsService`, `ServiceLocator.mapService` и т.д.; дублирование цепочки getBaseUrl → getInstance → new XxxService устранено. Подробности — [changes/api-client.md](changes/api-client.md), [adr/0004-mobile-service-locator-di.md](adr/0004-mobile-service-locator-di.md).
- **Mobile LocationService dispose (утечка памяти):** в `RunService` при создании без инжекции `LocationService` создавался новый экземпляр с `StreamController`, который никогда не освобождался. Добавлен флаг владения `_ownLocationService`; в `cancelRun()` при владении вызывается `_locationService.dispose()` и создаётся новый экземпляр для следующего `startRun()`. Добавлен метод `dispose()` для освобождения при уничтожении RunService (например в тестах). В `ProfileScreen` LocationService не создаётся — используется синглтон из ServiceLocator, вызов dispose там не требуется. Подробности — [changes/runs.md](changes/runs.md).
- **Mobile RunModel (DTO) vs RunSession (UI state):** RunSession — модель состояния трекера (idle/recording/result), без fromJson/toJson, без userId/endedAt/createdAt; duration — Duration, статус — RunSessionStatus (running, completed). Создана отдельная DTO `RunModel` для десериализации backend RunViewDto: id, userId, activityId?, startedAt, endedAt, duration (секунды → Duration), distance, status (RunModelStatus: completed, invalid), createdAt, updatedAt. RunService.submitRun парсит ответ 201 через RunModel.fromJson для согласованности с контрактом backend. Подробности — [changes/runs.md](changes/runs.md).
- **Mobile API error handling (activities, cities, clubs, territories):** в сервисах `ActivitiesService`, `CitiesService`, `ClubsService`, `TerritoriesService` добавлена проверка `response.statusCode` и обработка не-JSON ответов по образцу `EventsService.getEvents()`: при статусе != 200 выбрасывается `Exception`, при ответе не application/json или HTML — `FormatException` с понятным сообщением; парсинг JSON обёрнут в try/catch. Это устраняет FormatException при 404/500 и ответах с HTML. Подробности — [changes/activities.md](changes/activities.md), [changes/cities.md](changes/cities.md), [changes/clubs.md](changes/clubs.md), [changes/territories.md](changes/territories.md).
- **Backend: единый источник конфигурации БД:** конфигурация БД больше не дублируется в env.ts; единственный источник — `config/db.ts`. EnvConfig содержит только `port`; добавлена проверка parseInt на NaN для PORT и DB_PORT; загрузка .env вынесена в явный `loadEnv()` в server.ts. Подробности — [changes/database.md](changes/database.md).
- **Backend: единая auth-абстракция:** удалена дублирующая абстракция auth/service (AuthService, FirebaseAuthService); middleware и код используют только `modules/auth` (AuthProvider, FirebaseAuthProvider, getAuthProvider()). Удалён auth/service.ts; auth/types реэкспортирует типы из modules/auth. Подробности — [changes/auth.md](changes/auth.md).
- **Backend: общий тип координат (latitude, longitude):** введён shared тип `GeoCoordinates` в `shared/types/coordinates.ts`; city, territory, event, run, map используют его (CityCoordinates, TerritoryCoordinates, EventStartLocation, GpsPoint extends GeoCoordinates, MapCoordinates — алиасы). Устранено дублирование в 5 модулях. Подробности — [changes/backend-coordinates.md](changes/backend-coordinates.md).
- **Backend: CORS, rate limiting, express.json limit:** добавлены CORS middleware, rate limit 100 req/min per IP для /api (product_spec 18.1), явный limit для express.json (1mb). Подробности — [changes/backend-security.md](changes/backend-security.md).
- **Backend: env — loadEnv и parseInt NaN:** в env.ts добавлена функция `loadEnv()` для явной загрузки .env (вызов из server.ts); парсинг PORT и DB_PORT с проверкой на NaN и допустимый диапазон. Подробности — [changes/database.md](changes/database.md).
- **Mobile: GoRouter refreshListenable:** статический GoRouter дополнен `refreshListenable: authRefreshNotifier`; при вызове `authRefreshNotifier.refresh()` маршрутизатор обновляется (задел под реакцию на смену auth). Подробности — [changes/mobile-app.md](changes/mobile-app.md).
- **Mobile: EventsScreen — фильтры перезапрашивают данные:** при смене фильтра по дате или «Только открытые» вызывается `_eventsFuture = _fetchEvents()` и список событий перезагружается. Подробности — [changes/events.md](changes/events.md).
- **Mobile: исправление средних проблем (36-50):** исправлены проблемы навигации (context.go → context.push для сохранения back stack), оптимизирован O(n²) пересчёт дистанции в RunScreen, синхронизированы _onMapCreated и _loadMapData в MapScreen, исправлена обработка ошибок GPS permissions, убраны хардкоды, вынесена общая обработка ошибок в ErrorDisplay виджет, добавлен парсинг clubId в TerritoryModel, исправлены unsafe as int casts во всех моделях, исправлен api_config.dart для совместимости с Flutter Web. Подробности — [changes/mobile-fixes.md](changes/mobile-fixes.md).
- **Backend: исправление низких проблем (L-1–L-10):** исправлены технические проблемы кода: префикс _ для неиспользуемых параметров в error handler, адрес прослушивания сервера зависит от окружения (0.0.0.0 только в dev), добавлено приведение типов для req.query в events/map routes, роутеры переведены на barrel exports модулей, интерфейс Notification переименован в UserNotification для избежания конфликта с Web API, исправлен дублирующийся re-export в auth barrel, переименовано поле isMercantile → isMercenary во всех файлах. Подробности — [changes/backend-low-issues.md](changes/backend-low-issues.md).
- **Mobile: исправление низких проблем (L-11–L-27):** исправлены технические проблемы кода: убраны бесполезные try/catch с rethrow в ApiClient, заменены deprecated withOpacity() на Color.fromRGBO, исправлена иммутабельность RunSession.gpsPoints, добавлены TODO комментарии для i18n/Equatable/retry, исправлены фильтры событий (отправка query параметров), заменено ручное форматирование дат на DateFormat, вынесен общий виджет NotificationItem для устранения дублирования, добавлен copyWith для MapFilters, удалён неиспользуемый метод _showEventCard. Подробности — [changes/mobile-low-issues-l11-l27.md](changes/mobile-low-issues-l11-l27.md).
