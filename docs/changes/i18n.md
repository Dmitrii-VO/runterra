# i18n — локализация строк (mobile)

## Дата

2026-02-02

## Цель

Ввести единую локализацию пользовательских строк в мобильном приложении (Flutter): убрать хардкод русских/английских строк, поддержать переключение языка (ru/en), подготовить основу для добавления новых локалей.

## Выбранный подход

- **Официальный Flutter l10n:** генерация кода из ARB-файлов (`flutter gen-l10n`), класс `AppLocalizations` в `lib/l10n/`.
- **Локали:** русский (ru), английский (en). Fallback по умолчанию — ru (задаётся в `localeResolutionCallback` в `app.dart`).
- **Источники строк:** `mobile/l10n/app_en.arb` (шаблон), `mobile/l10n/app_ru.arb`. Ключи в camelCase (например `navMap`, `errorLoadTitle`, `profileCityRequired`).
- **Параметризованные строки:** через плейсхолдеры в ARB (например `errorGeneric(message)`, `participantsTitle(count)`).

## Изменения

### Зависимости и конфигурация

- **pubspec.yaml:** добавлены `flutter_localizations` (sdk), обновлён `intl` до `^0.20.2` (требование flutter_localizations), включён `flutter.generate: true`.
- **l10n.yaml:** `arb-dir: l10n`, `output-dir: lib/l10n`, `template-arb-file: app_en.arb`, `output-localization-file: app_localizations.dart`.
- **mobile/l10n/:** созданы `app_en.arb` и `app_ru.arb` с полным набором ключей для навигации, ошибок, профиля, событий, карты, пробежки, логина, экранов деталей и т.д.

### Подключение в приложении

- **app.dart:** в `MaterialApp.router` добавлены `localizationsDelegates: AppLocalizations.localizationsDelegates`, `supportedLocales: AppLocalizations.supportedLocales`, `localeResolutionCallback` (выбор ru/en по устройству, иначе ru).

### Замена строк в коде

Все пользовательские строки в UI заменены на вызовы `AppLocalizations.of(context)!.<key>` (или с параметрами). Затронуты:

- Навигация: `bottom_nav.dart` (подписи вкладок).
- Ошибки: `error_display.dart` (заголовок, сообщения таймаута/сети/общее, кнопка «Повторить»).
- Сообщения: `messages_screen.dart`, `global_chat_tab.dart`, `club_messages_tab.dart`, `notifications_tab.dart` (заголовки, плейсхолдеры, пустые состояния, кнопки).
- Профиль: `profile_screen.dart`, `header_section.dart`, `quick_actions_section.dart`, `activity_section.dart`, `settings_section.dart`, `stats_section.dart`, `notifications_section.dart`.
- События: `events_screen.dart`, `event_details_screen.dart`, `events/widgets/event_card.dart`, `participants_list.dart`.
- Карта: `map_screen.dart`, `map_filters.dart`, `territory_bottom_sheet.dart`, `map/widgets/event_card.dart`.
- Пробежка: `run_screen.dart` (кнопки, статусы GPS, дистанция/время, сообщения об ошибках).
- Логин: `login_screen.dart`.
- Детальные экраны: `activity_details_screen.dart`, `city_details_screen.dart`, `club_details_screen.dart`, `territory_details_screen.dart` (заголовки, подписи полей, «Нет данных»).

Удалены TODO-комментарии, относящиеся к i18n, в `activity_section.dart`, `event_card.dart` (events), `event_details_screen.dart`.

### Документация и правила

- **.cursorrules:** добавлено правило: в mobile все пользовательские строки в UI — только через `AppLocalizations`; новые ключи добавлять в оба ARB-файла.
- **docs/progress.md:** добавлена запись о внедрении i18n в mobile.

## Правила добавления новых строк

1. Добавить ключ (camelCase) в `mobile/l10n/app_en.arb` и в `mobile/l10n/app_ru.arb` с переводами.
2. Для строк с параметрами — описать плейсхолдеры в `@key` с `placeholders`.
3. Выполнить `flutter gen-l10n` (или `flutter pub get` при включённом `generate: true`).
4. В коде использовать `AppLocalizations.of(context)!.<key>` или `AppLocalizations.of(context)!.<key>(param)`.

## Code review fix (2026-02-02)

После внедрения i18n обнаружены и исправлены 6 пропущенных хардкод-строк:

| Файл | Было | Стало (ключ ARB) |
|------|------|-------------------|
| `login_screen.dart` | `'Ошибка входа: ...'` | `loginError(error)` |
| `run_screen.dart` | `'Пробежка будет засчитана...'` | `runForActivity(activityId)` |
| `run_screen.dart` | `'Начать пробежку'` | `runStart` |
| `settings_section.dart` | `'Выйти из аккаунта'` | `settingsLogout` |
| `club_details_screen.dart` | `'Клуб'` | `clubDetailsTitle` |
| `territory_details_screen.dart` | `'Статус'` | `detailStatus` |

Также исправлены 3 вызова deprecated `withOpacity()` → `Color.fromRGBO()` (в `events/widgets/event_card.dart`, `map/widgets/event_card.dart`, `activity_section.dart`) и добавлен пропущенный `const` в `global_chat_tab.dart`.

## Связанные документы

- [docs/progress.md](../progress.md) — запись о внедрении i18n.
- [docs/api-errors-and-validation.md](../api-errors-and-validation.md) — локализация текстов ошибок API выполняется на клиентах; backend возвращает только коды и английские сообщения.
