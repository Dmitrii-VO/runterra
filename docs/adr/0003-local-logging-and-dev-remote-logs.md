# ADR 0003: Локальное логирование и dev-отправка логов на удалённый сервер

**Статус:** Принято  
**Дата:** 2026-01-29  
**Обновлено:** 2026-01-29 — единый удалённый лог-сервер вместо эндпоинта на backend  
**Заменяет:** ADR 0001 в части реализации на skeleton-этапе (Sentry остаётся целевым вариантом для продакшена, но временно не используется)

## Контекст

На skeleton-этапе:

- инфраструктура для self-hosted Sentry ещё не развернута;
- нужен единый приём логов от backend, mobile и admin только в dev;
- в PROD на внешний лог-сервер ничего не должно отправляться.

Требования: обычный HTTP POST, Content-Type: application/json, без внешних SDK, без чувствительных данных, изолированный и легко удаляемый код.

## Решение

- **Единый dev-лог-сервер** принимает POST `/log` (например `http://176.108.255.4:4000/log`), ответ `204 No Content`, тело — JSON.
- **Backend:** при вызове `logger.error`/`logger.warn` в dev дополнительно отправляется POST на этот сервер через `devLogClient` (fire-and-forget). Эндпоинта приёма логов на нашем backend нет.
- **Mobile / Admin:** в dev (когда задан URL лог-сервера) отправляют ошибки напрямую на этот же URL; в prod URL не задаётся — запросы не выполняются.

## Детали реализации

### Backend

- **logger** (`backend/src/shared/logger.ts`): как раньше, плюс при `error`/`warn` вызов `sendDevLog(level, message, context)`.
- **devLogClient** (`backend/src/shared/devLogClient.ts`):
  - Работает только при `NODE_ENV !== 'production'` и заданном `DEV_LOG_SERVER_URL` (по умолчанию в dev: `http://176.108.255.4:4000`).
  - POST на `${url}/log`, санитизация context (исключение токенов, паролей, координат и т.п.), fire-and-forget.
- Эндпоинт `POST /dev/log` удалён; клиенты отправляют логи напрямую на удалённый сервер.

### Mobile (Flutter)

- **DevRemoteLogger**: отправка только когда задан `--dart-define=DEV_LOG_SERVER=...` (например `http://176.108.255.4:4000`). В prod (без define) запросы не выполняются. Путь: `${baseUrl}/log`.

### Admin (Next.js)

- Утилита **sendDevLog** в `admin/src/shared/devLogClient.ts`: отправка только при заданном `NEXT_PUBLIC_DEV_LOG_SERVER`; для использования при ошибках API/UI.

## Последствия

- ✅ Один сервер приёма логов в dev; в prod ничего не уходит.
- ✅ Нет эндпоинта приёма логов на нашем backend — меньше поверхность атаки.
- ✅ Код изолирован (devLogClient / DevRemoteLogger), легко удалить после dev-этапа.
- ⚠️ Нет UI для просмотра ошибок (только файл логов на сервере).

## Статус

- ADR 0003 принят; реализация приведена к единому удалённому лог-серверу с отправкой только в dev.

