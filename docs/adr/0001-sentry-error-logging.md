# ADR 0001: Использование Sentry для логирования ошибок пользователей

**Статус:** Принято  
**Дата:** 2025-01-27  
**Контекст:** Необходимо видеть ошибки, возникающие у пользователей в production

## Контекст

На стадии skeleton проекта Runterra необходимо обеспечить видимость ошибок, возникающих у пользователей:
- Краши и необработанные исключения на мобильных устройствах (Flutter)
- Сбои API на backend (Node.js)
- Ошибки в админке (Next.js, в будущем)

Согласно [product_spec.md](../product_spec.md), раздел «Мониторинг» (стр. 459), для ошибок используется **Sentry**.

## Решение

Использовать **Sentry** для сбора и мониторинга ошибок во всех компонентах системы:
- **Mobile:** `sentry_flutter` для Flutter приложения
- **Backend:** `@sentry/node` для Node.js/Express сервера
- **Admin:** `@sentry/nextjs` (отложено на будущее)

### Архитектура

```
┌─────────────┐         ┌─────────────┐
│   Mobile    │────────▶│   Sentry    │
│  (Flutter)  │         │     Cloud   │
└─────────────┘         └─────────────┘
                              ▲
┌─────────────┐               │
│   Backend   │───────────────┘
│ (Node.js)   │
└─────────────┘
```

### Что логируется

1. **Необработанные ошибки:**
   - Mobile: через `FlutterError.onError` и `runZonedGuarded`
   - Backend: через Express error handler middleware

2. **Явные ошибки в ключевых местах:**
   - Mobile: ошибки GPS, обновления карты, загрузки событий
   - Backend: ошибки пула подключений PostgreSQL

3. **Ошибки, видимые пользователю:**
   - Mobile: ошибки загрузки данных, которые отображаются в UI (например, `snapshot.hasError` в FutureBuilder)

### Что НЕ логируется

- Структурированные application logs (debug, info) — только ошибки
- Performance monitoring (tracesSampleRate = 0.0 на skeleton)
- Продуктовая аналитика (PostHog/Mixpanel) — отдельная система
- Рутовые 4xx без контекста (например, 401 при истёкшей сессии) — чтобы не засорять квоту

## Последствия

### Положительные

- ✅ Централизованный сбор ошибок в одном месте
- ✅ Автоматический сбор stack traces и контекста
- ✅ Группировка похожих ошибок
- ✅ Уведомления о критичных ошибках (при настройке alerts)
- ✅ Интеграция с существующим стеком (уже указан в product_spec)

### Отрицательные

- ⚠️ Зависимость от внешнего сервиса (Sentry)
- ⚠️ Ограничения по квоте на бесплатном плане
- ⚠️ Необходимость настройки DSN для каждого окружения

### Митигация

- В development при пустом DSN Sentry не инициализируется (не блокирует локальную разработку)
- Фильтрация повторяющихся ошибок для экономии квоты
- Возможность переключения на self-hosted Sentry в будущем (если потребуется)

## Альтернативы

### Рассмотренные варианты

1. **Firebase Crashlytics**
   - ❌ Не указан в product_spec
   - ❌ Только для мобильных приложений (нет поддержки backend)

2. **Собственное решение (логирование в БД)**
   - ❌ Изобретение велосипеда
   - ❌ Нет автоматической группировки и анализа
   - ❌ Требует разработки UI для просмотра логов

3. **Grafana + Loki**
   - ❌ Предназначен для серверных логов, не для клиентских ошибок
   - ❌ Нет автоматического сбора stack traces с мобильных устройств
   - ❌ Сложнее в настройке для skeleton стадии

### Почему Sentry

- ✅ Уже закреплён в product_spec
- ✅ Поддержка всех платформ (Flutter, Node.js, Next.js)
- ✅ Автоматический сбор контекста и stack traces
- ✅ Готовая интеграция с минимальными изменениями кода
- ✅ Бесплатный план достаточен для начала

## Реализация

См. [changes/logging.md](../changes/logging.md) для деталей реализации.

## Статус

Принято и реализовано 2025-01-27.
