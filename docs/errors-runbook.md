# Журнал ошибок и исправлений (Errors Runbook)

Документ для повторных проверок логов: что уже исправлено, что считать новым. При команде «посмотри ошибки в логах» — сначала читать этот файл, затем логи; реагировать только на ошибки, которых нет в списке «Исправлено».

---

## Как пользоваться

1. **Перед разбором логов** — прочитать этот файл (секция «Исправлено»).
2. **Скачать/посмотреть логи** (ssh runterra, journalctl, error-*.log).
3. **Сопоставить с runbook:** если ошибка совпадает с пунктом из «Исправлено» — не предлагать правку заново. Работать только с ошибками, которых нет в «Исправлено».
4. **В конце** прочитать **docs/progress.md** и соотнести найденные (новые) ошибки с прогрессом: недавние фичи, деплои — чтобы интерпретировать ошибки в контексте.
5. После исправления новой ошибки — добавить в «Исправлено» с датой; при необходимости кратко в docs/progress.md.

---

## Исправлено (не предлагать повторно)

Формат: краткое описание | сигнатура в логах | что сделано | дата.

- **Пробежка с нулевой длительностью (500)**  
  Сигнатура: `"Error creating run"`, `runs_duration_positive`, `constraint`, `duration` 0.  
  Что сделано: в `backend/src/api/runs.routes.ts` добавлена проверка `duration >= 30` до вызова репозитория; при нарушении возврат 400 с сообщением «duration must be at least 30 seconds».  
  Дата: 2026-02-03.

- **Глобальные сообщения — невалидный cityId (500)**
  Сигнатура: `"Error fetching global messages"`, `string_to_uuid`, `parameter $2 = '...'`, код 22P02.
  Что сделано: в `backend/src/api/messages.routes.ts` для GET `/global` добавлена валидация `cityId` как UUID; при невалидном значении возврат 400 «cityId must be a valid UUID».
  Дата: 2026-02-03.

- **Повторный старт пробежки — `Exception: Run already started`**
  Сигнатура: на вкладках «Пробежка» и «Карта» внизу показывается красный баннер `Ошибка при запуске пробежки: Exception: Run already started`, при этом UI остаётся в состоянии «Начать пробежку» без таймера и маршрута.
  Что сделано: (1) в `RunService` добавлен метод `clearCompletedSession()` для очистки завершённых сессий; (2) `startRun()` автоматически очищает завершённые (completed) сессии перед стартом — выбрасывает исключение только для running-сессий; (3) в `RunScreen.initState()` при возврате на вкладку восстанавливается UI для running и completed сессий; (4) `_backToIdle()` теперь вызывает `clearCompletedSession()`; (5) при исключении «Run already started» показывается диалог с выбором «Продолжить» или «Отменить и начать заново»; (6) добавлены i18n ключи `runStuckSessionTitle`, `runStuckSessionMessage`, `runStuckSessionResume`, `runStuckSessionCancel` (EN/RU).
  Дата: 2026-02-04.

---

## Известные открытые (не из логов backend)

- **Вылет при «Начать пробежку» в Nox** — краш на эмуляторе при старте foreground service (GPS). Решение не вводили: оставлен фоновый режим и в debug по запросу. Не бэкенд, не логи runterra.

---

## Ожидаемые предупреждения (не ошибки)

- **POST "/" и GET "/" → 404** — запросы к корню от сканеров/ботов; 404-обработчик возвращает `{ code, message }` (исправлено 2026-02-02). В логах level `warn`. Не требуюют правок.

## Где смотреть логи

- **Backend (runterra):**  
  - systemd: `ssh runterra "journalctl -u runterra-backend -n 500 --no-pager"`  
  - Файлы: `ssh runterra "tail -200 /home/user1/runterra/logs/error-YYYY-MM-DD.log"`  
- **Дата в имени файла** — по UTC (или по серверу). Для «сегодня» подставлять актуальную дату.

При добавлении нового пункта в «Исправлено» указывать дату и файлы/коммиты, чтобы не дублировать правки.
