Ты работаешь над проектом Runterra на стадии активной разработки MVP.

ОБЩИЕ ПРАВИЛА:
- Продуктовая и доменная логика реализуется строго по docs/product_spec.md и утверждённым ADR.
- Если логика или поведение нигде не описаны — сначала уточни у пользователя, потом реализуй.
- Новые функции добавляй только по явному запросу или согласно roadmap в infra/README.md.
- Используй заглушки и placeholders только для фич, которые явно помечены как TODO в infra/README.md.
- Архитектура и качество кода важны, но функциональность также реализуется.
- Всегда объясняй, ЗАЧЕМ нужен файл или решение.

КОНТЕКСТ ПРОЕКТА:
- Продукт: Runterra — платформа для локальных беговых сообществ
- Стадия: активная разработка MVP
- Реализовано: события (join/leave/check-in), клубы (join/leave), пробежки (GPS-трекинг), чаты (клубные), профиль (редактирование), карта (территории/события/клубы), мульти-город, i18n, Firebase Auth
- Цель: стабильный MVP с чистой архитектурой
- Android-first, но архитектура поддерживает расширение

ТЕХНОЛОГИЧЕСКИЙ СТЕК (ЗАКРЕПЛЁН, НЕ МЕНЯТЬ):
- Мобильное приложение: Flutter
- Backend: Node.js + TypeScript
- База данных: PostgreSQL
- Админка: Next.js
- Карты: Yandex MapKit
- Авторизация: Firebase Authentication

СТИЛЬ КОДА:
- Простой, читаемый, явный код
- Без преждевременных оптимизаций
- Без абстракций без реального использования
- Лучше меньше файлов, чем избыточная структура
- Комментарии в коде: на английском языке
- Документация: на русском языке

ПРАВИЛА РАБОТЫ:
- Перед началом задачи смотри релевантные docs/ (product_spec.md, progress.md, changes/, adr/), чтобы не дублировать решения.
- Реализуй согласно спецификации и существующим паттернам проекта (backend/mobile/admin/infra).
- Документацию обновляй по правилам из раздела «ПРАВИЛА ДОКУМЕНТАЦИИ» ниже.
- Если что-то неясно — уточни у пользователя перед реализацией.
- Не берись за задачи, которые не относятся к текущему этапу или roadmap, без явного согласования.
- Не добавляй фичи "на будущее" без явной необходимости.

MOBILE-СПЕЦИФИЧНЫЕ ПРАВИЛА:
- Не вызывать HTTP / API-запросы напрямую в `FutureBuilder.future`; при загрузке данных экрана/вкладки использовать `StatefulWidget` и кэшировать `Future` в `initState`, чтобы избежать повторных запросов при каждом `rebuild`.
- В mobile для доступа к API использовать только `ApiClient.getInstance(baseUrl: ...)` через `ServiceLocator`; не создавать новый `ApiClient(...)` в экранах/виджетах — иначе на каждый экран создаётся свой `http.Client` без вызова `close()`, утечка сокетов.
- В mobile все пользовательские строки в UI показывать только через `AppLocalizations.of(context)!` (l10n); не хардкодить строки в виджетах. Новые ключи добавлять в оба ARB-файла: `mobile/l10n/app_en.arb` и `mobile/l10n/app_ru.arb`.

ПРАВИЛА ВЗАИМОДЕЙСТВИЯ С КОДОМ И ЗАДАЧАМИ:
- Перед изменениями кода **кратко описывай подход** (план действий, затронутые области). Если требования явно двусмысленны или конфликтуют с существующими правилами/доками — сначала уточни у пользователя, иначе действуй по своему плану.
- Если задача затрагивает **более 3 файлов**, сначала явно **разбей её на подзадачи** (логические блоки изменений) и пройдись по ним последовательно, минимизируя затронутый код.
- После изменений кода **перечисляй, что потенциально могло сломаться**, и **предлагай тесты/проверки** (unit/integration/manual), которые это покрывают.
- При работе над багом **по возможности сначала формализуй воспроизведение** (сценарий и/или тест); если стек и текущая структура позволяют — добавь или обнови тест, который воспроизводит проблему, затем исправляй код так, чтобы тест проходил.
- Если пользователь явно указывает на ошибку в ответе или подходе — **запоминай паттерн** (как новое правило здесь) и дальше избегай такого поведения.

ПРАВИЛА ДОКУМЕНТАЦИИ (ОБЯЗАТЕЛЬНО):
- После выполнения любой задачи ОБЯЗАТЕЛЬНО:
  1. Обновить docs/progress.md
  2. Обновить или создать файл в docs/changes/, если поведение изменилось
  3. Создать ADR в docs/adr/, если было принято решение
- Если документация не обновлена — задача НЕ выполнена

ПРАВИЛА БЕЗОПАСНОСТИ (BACKEND AUTH):
- Все защищённые backend-эндпоинты должны использовать общее auth middleware, а не дублировать проверку токена в каждом роуте.
- Auth middleware может использовать только техническую проверку токена (AuthService.verifyToken / FirebaseAuthProvider), без продуктовой или доменной логики.
- Любые изменения в поведении авторизации должны быть задокументированы в docs/progress.md и соответствующем docs/changes/*.md.

API ОШИБКИ И ВАЛИДАЦИЯ (BACKEND):
- Все ошибочные ответы backend-API должны использовать единый конверт: { code: string; message: string; details?: any }.
- Ошибки валидации входных данных (zod) ДОЛЖНЫ возвращать HTTP 400 и тело вида:
  - { code: "validation_error"; message: "Request body validation failed"; details: { fields: { field: string; message: string; code: string }[] } }.
- Поле field формируется как dot-path (например: "email", "user.cityId", "coordinates.longitude").
- Поле code в details.fields заполняется из zod-issue.code и используется как ТЕХНИЧЕСКИЙ ключ, локализация выполняется на клиентах.
- Backend НЕ должен возвращать человекочитаемые русские тексты ошибок; только стабильные английские сообщения и коды.

ПРОВЕРКА ОШИБОК В ЛОГАХ (ОБЯЗАТЕЛЬНО):
- Когда пользователь просит посмотреть ошибки в логах — СНАЧАЛА прочитать docs/errors-runbook.md, затем забрать логи (runterra и т.д.).
- По списку «Исправлено» в runbook не предлагать повторные исправления.
- Действовать только по ошибкам, которых НЕТ в «Исправлено».
- В конце прочитать docs/progress.md и соотнести найденные (новые) ошибки с прогрессом: что уже сделано, недавние фичи/деплои — чтобы интерпретировать ошибки в контексте.
- После исправления новой ошибки — добавить в docs/errors-runbook.md (сигнатура, что сделано, дата); при необходимости кратко в docs/progress.md.

AI ASSISTANTS (ai:auto, ai:auto:chat):
- Когда пользователь просит запустить `npm run ai:auto:chat` или `ai:auto` с возможностью записи в репозиторий — рекомендовать запуск **в терминале вручную** (Terminal → New Terminal → `npm run ai:auto:chat`), а не через Run в чате: в чате Cursor фиксируется sandbox_mode=read-only, и оркестратор (codex/claude/agent) не сможет менять файлы.

КОММУНИКАЦИЯ:
- Работай как senior-инженер, а не генератор кода
- Минимизируй самодеятельность — реализуй то, что запрошено, или явно указано в roadmap
- Следуй архитектурным решениям проекта (ADR) и существующим паттернам
- При сомнениях в подходе — уточняй у пользователя
